<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Acompanhamento de Obras</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#071b12; --txt:#eaf7ef; --muted:rgba(234,247,239,.72);
      --line:rgba(255,255,255,.10);
      --brand:#48d18d; --danger:#ff6b6b;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius2: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: Arial, sans-serif; color:var(--txt);
      background: radial-gradient(1400px 700px at 20% 0%, #0f3c27 0%, var(--bg0) 45%, #041109 100%);
      min-height:100vh;
    }
    .wrap{ max-width:1180px; margin:0 auto; padding:18px; }

    header{ display:flex; align-items:flex-start; justify-content:space-between; gap:14px; margin-bottom:14px; }
    h1{ margin:0; letter-spacing:.3px; font-size:28px; line-height:1.1; }
    .subtitle{ color:var(--muted); margin-top:6px; font-size:14px; }
    .top-right{ text-align:right; display:flex; flex-direction:column; align-items:flex-end; gap:10px; }
    .today{
      font-family:var(--mono); font-size:14px; color:var(--muted);
      padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.04);
      width:max-content;
    }
    .btn{
      border:1px solid var(--line); background:rgba(255,255,255,.06); color:var(--txt);
      padding:10px 14px; border-radius:999px; cursor:pointer; font-weight:700; transition:.15s ease;
    }
    .btn:hover{ transform: translateY(-1px); background:rgba(255,255,255,.10); }
    .btn.brand{ background: linear-gradient(180deg, rgba(72,209,141,.22), rgba(72,209,141,.12)); border-color: rgba(72,209,141,.35); }
    .btn.brand:hover{ background: linear-gradient(180deg, rgba(72,209,141,.30), rgba(72,209,141,.16)); }
    .btn.ghost{ background:transparent; }
    .btn.small{ padding:7px 10px; font-weight:800; border-radius:12px; }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding:14px;
      box-shadow: var(--shadow);
      margin-bottom:14px;
    }
    .panel-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{
      padding:8px 12px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.05); color:var(--muted); font-size:12px;
    }
    .tabs{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .tab{
      cursor:pointer; user-select:none; font-weight:800;
      padding:10px 12px; border-radius:999px; border:1px solid transparent; color:var(--muted);
    }
    .tab.active{ color:var(--txt); border-color: rgba(72,209,141,.35); background:rgba(72,209,141,.12); }

    .section{ display:none; gap:12px; flex-wrap:wrap; margin-top:12px; border-top:1px solid var(--line); padding-top:12px; }
    .section.show{ display:flex; }
    .field{ min-width:220px; flex:1; }
    .field label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background: rgba(0,0,0,.25); color:var(--txt); outline:none;
    }
    textarea{ resize:vertical; }
    .rules{ margin-top:10px; color:var(--muted); font-size:12px; line-height:1.4; }
    .rules strong{ color: var(--txt); }

    .checks{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:10px 12px; border:1px solid var(--line); border-radius:12px; background: rgba(0,0,0,.20);
    }
    .chk{
      display:flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.04); color:var(--txt);
      cursor:pointer; user-select:none; font-size:13px;
    }
    .chk input{ width:auto; }

    .error{
      margin-top:12px; border:1px solid rgba(255,107,107,.35);
      background: rgba(255,107,107,.10); padding:12px; border-radius:14px; color:#ffd9d9; white-space:pre-wrap;
      display:none;
    }

    .bases{ margin-top:14px; display:grid; gap:14px; }
    .base-card{
      border:1px solid var(--line); border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.10));
      overflow:hidden;
    }
    .base-head{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px 14px; background: rgba(0,0,0,.18); border-bottom:1px solid var(--line);
    }
    .base-title{ font-weight:900; letter-spacing:.3px; }
    .base-count{
      color:var(--muted); font-size:12px; font-family:var(--mono);
      padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.04);
    }

    .table{ width:100%; overflow:auto; }
    .row{
      display:grid; gap:10px; padding:12px 14px; border-bottom:1px solid var(--line); align-items:center;
    }
    .row.head{
      position:sticky; top:0; background: rgba(7,27,18,.92); backdrop-filter: blur(10px);
      z-index:2; font-weight:900; color:var(--muted); font-size:12px;
      text-transform:uppercase; letter-spacing:.06em;
    }
    .cell{
      font-size:13px; line-height:1.25; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .cell.mono{ font-family:var(--mono); font-size:12px; color:var(--muted); }
    .cell strong{ color:var(--txt); }
    .badge{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      background: rgba(72,209,141,.12); border:1px solid rgba(72,209,141,.25); color:var(--txt);
      font-weight:900; font-size:12px; width:max-content;
    }
    .badge.gray{ background: rgba(255,255,255,.06); border-color: var(--line); color:var(--muted); font-weight:800; }
    .actions{ display:flex; gap:8px; justify-content:flex-end; align-items:center; }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background: rgba(0,0,0,.62);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:999;
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width:min(820px, 100%); background: rgba(7,27,18,.96);
      border:1px solid var(--line); border-radius: var(--radius2); box-shadow: var(--shadow); overflow:hidden;
    }
    .modal-head{
      padding:14px 16px; display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom:1px solid var(--line); background: rgba(0,0,0,.18);
    }
    .modal-title{ font-weight:900; }
    .modal-body{ padding:14px 16px; display:grid; gap:12px; }
    .modal-actions{ padding:14px 16px; display:flex; gap:10px; justify-content:flex-end; border-top:1px solid var(--line); }
    .grid2{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; }

    footer{ margin-top:18px; text-align:center; color:var(--muted); font-size:12px; padding:16px 6px; }

    @media (max-width: 980px){
      .row.head{ display:none; }
      .cell{ white-space:normal; }
      .actions{ justify-content:flex-start; flex-wrap:wrap; }
      .grid2{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Acompanhamento de Obras</h1>
        <div class="subtitle">UTEP Nordeste ‚Ä¢ Supabase + GitHub Pages</div>
      </div>
      <div class="top-right">
        <div class="today" id="todayTop">--/--/----</div>
        <button class="btn brand" id="btnReload">Recarregar</button>
      </div>
    </header>

    <div class="panel">
      <div class="panel-head">
        <div class="tabs">
          <div class="tab active" id="tabFiltros">Filtros</div>
          <div class="tab" id="tabColunas">Colunas</div>
        </div>

        <div class="toolbar">
          <button class="btn brand" id="btnExport">Exportar WhatsApp</button>
          <span class="pill" id="pillInfo">Carregando‚Ä¶</span>
        </div>
      </div>

      <!-- FILTROS -->
      <div class="section show" id="filtersArea">
        <div class="field">
          <label>Data (prazo final)</label>
          <input type="date" id="inpDate">
        </div>
        <div class="field">
          <label>Base</label>
          <select id="selBase">
            <option value="">Todas</option>
          </select>
        </div>
        <div class="field">
          <label>Munic√≠pio</label>
          <select id="selMunicipio">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="field">
          <label>Crit√©rio</label>
          <select id="selCriterio">
            <option value="">Todos</option>
          </select>
        </div>
      </div>

      <!-- COLUNAS (mostrar/ocultar na lista e no export) -->
      <div class="section" id="colsArea">
        <div class="field" style="min-width:100%;">
          <label>Escolha o que aparece na lista (e no WhatsApp)</label>
          <div class="checks" id="colsChecks"></div>
        </div>
      </div>

      <div class="rules">
        <strong>Regras:</strong> mostra obras com <strong>prazo final</strong> na data escolhida.
        Se n√£o houver, mostra as <strong>5 mais pr√≥ximas</strong> dentro de <strong>5 dias</strong> (por base).
      </div>

      <div class="error" id="errBox"></div>
    </div>

    <div class="bases" id="basesContainer"></div>

    <footer>UTEP Nordeste ‚Ä¢ Atualiza automaticamente quando voc√™ faz commit no GitHub</footer>
  </div>

  <!-- MODAL: WhatsApp Export -->
  <div class="modal-backdrop" id="modalExport">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">Exportar WhatsApp</div>
        <button class="btn ghost" id="btnCloseExport">Fechar</button>
      </div>
      <div class="modal-body">
        <div class="grid2">
          <div class="field">
            <label>Data inicial</label>
            <input type="date" id="expStart">
          </div>
          <div class="field">
            <label>Data final</label>
            <input type="date" id="expEnd">
          </div>
        </div>

        <div class="field">
          <label>Bases para exportar</label>
          <div class="checks" id="expBases"></div>
        </div>

        <div class="field">
          <label>Pr√©via</label>
          <textarea id="expPreview" rows="10" placeholder="A pr√©via vai aparecer aqui‚Ä¶" readonly></textarea>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" id="btnBuildPreview">Gerar pr√©via</button>
        <button class="btn brand" id="btnSendWA">Abrir WhatsApp</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Notas -->
  <div class="modal-backdrop" id="modalNotes">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title" id="notesTitle">Notas</div>
        <button class="btn ghost" id="btnCloseNotes">Fechar</button>
      </div>
      <div class="modal-body">
        <div class="grid2">
          <div class="field">
            <label>Seu nome</label>
            <input id="noteAuthor" placeholder="Ex.: Jo√£o Silva">
          </div>
          <div class="field">
            <label>Status</label>
            <select id="noteStatus">
              <option value="Executada">Executada</option>
              <option value="Problemas na execu√ß√£o">Problemas na execu√ß√£o</option>
              <option value="N√£o foi executada">N√£o foi executada</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>Adicionar nota</label>
          <textarea id="noteText" rows="4" placeholder="Escreva a observa√ß√£o desta obra..."></textarea>
        </div>

        <div class="toolbar">
          <button class="btn brand small" id="btnSaveNote">Salvar nota</button>
          <button class="btn small" id="btnReloadNotes">Recarregar notas</button>
        </div>

        <div class="error" id="notesErr" style="display:none;"></div>

        <div class="panel" style="margin:0; padding:12px; background:rgba(0,0,0,.14);">
          <div style="font-weight:900; margin-bottom:8px;">Hist√≥rico</div>
          <div id="notesList" style="display:grid; gap:10px;"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/** CONFIG */
const SUPABASE_URL = "https://yyfhnuafwzeglwcpnmkd.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_7rmfNL9N6limSSFxFcl2Og_MV9xkbjx";

const TBL_OBRAS = "obras";
const TBL_NOTES = "notes";

/** COLUNAS (todas min√∫sculas) */
const COLS = {
  nota: "nota",
  projeto: "projeto",
  titulo: "titulo",
  municipio: "municipio",
  criterio: "criterio",
  base: "base_oper_prog",
  prazo: "previsao_execucao_fim",
  agente: "agente_responsavel",
  avnp: "avnp", // ‚úÖ correto: avnp
};

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** UI */
const elErr = document.getElementById("errBox");
const elPill = document.getElementById("pillInfo");
const elBases = document.getElementById("basesContainer");

const tabFiltros = document.getElementById("tabFiltros");
const tabColunas = document.getElementById("tabColunas");
const filtersArea = document.getElementById("filtersArea");
const colsArea = document.getElementById("colsArea");

const inpDate = document.getElementById("inpDate");
const selBase = document.getElementById("selBase");
const selMunicipio = document.getElementById("selMunicipio");
const selCriterio = document.getElementById("selCriterio");
const colsChecks = document.getElementById("colsChecks");

document.getElementById("btnReload").addEventListener("click", () => loadAll(true));

/** Estado */
let ALL_OBRAS = [];
let BASES = [];

/** Util */
function showError(msg){ elErr.style.display="block"; elErr.textContent=msg; }
function clearError(){ elErr.style.display="none"; elErr.textContent=""; }

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function fmtDateBR(d){
  if(!d) return "‚Äî";
  const dt = new Date(d);
  if(Number.isNaN(dt.getTime())) return String(d);
  return dt.toLocaleDateString("pt-BR",{ timeZone:"America/Sao_Paulo" });
}

function addDays(isoDate, days){
  const [y,m,d] = isoDate.split("-").map(Number);
  const dt = new Date(y, m-1, d);
  dt.setDate(dt.getDate()+days);
  const y2 = dt.getFullYear();
  const m2 = String(dt.getMonth()+1).padStart(2,"0");
  const d2 = String(dt.getDate()).padStart(2,"0");
  return `${y2}-${m2}-${d2}`;
}

function uniq(arr){
  return [...new Set(arr.filter(v => v !== null && v !== undefined && String(v).trim() !== ""))]
    .sort((a,b)=>String(a).localeCompare(String(b)));
}

function normNota(n){
  if(n === null || n === undefined) return "";
  let s = String(n).trim();
  if(s.endsWith(".0")) s = s.slice(0,-2);
  return s;
}

function toPercent(value){
  if(value === null || value === undefined || value === "") return "‚Äî";
  let n = Number(String(value).replace(",", "."));
  if(!Number.isFinite(n)) return "‚Äî";
  if(n <= 1) n = n * 100;
  n = Math.max(0, Math.min(100, n));
  return `${Math.round(n)}%`;
}

function safeText(v){ return (v === null || v === undefined || v === "") ? "‚Äî" : String(v); }

/** Safe select: remove colunas inexistentes */
async function safeSelect(table, cols){
  let columns = [...cols];
  while(columns.length){
    const sel = columns.join(",");
    const { data, error } = await supabase.from(table).select(sel);
    if(!error) return { data, columns, error:null };

    const msg = (error.message || "") + " " + (error.details || "");
    if(String(error.code) === "42703" || msg.includes("does not exist")){
      const m = msg.match(/column\s+([a-zA-Z0-9_."]+)\s+does not exist/i);
      if(m && m[1]){
        let col = m[1].replace(/"/g,"");
        if(col.includes(".")) col = col.split(".").pop();
        columns = columns.filter(c => c !== col);
        continue;
      }
      columns.pop();
      continue;
    }
    return { data:null, columns, error };
  }
  return { data:null, columns:[], error:{ message:"N√£o foi poss√≠vel selecionar colunas." } };
}

/** Tabs */
function setTab(which){
  if(which==="filtros"){
    tabFiltros.classList.add("active");
    tabColunas.classList.remove("active");
    filtersArea.classList.add("show");
    colsArea.classList.remove("show");
  } else {
    tabColunas.classList.add("active");
    tabFiltros.classList.remove("active");
    colsArea.classList.add("show");
    filtersArea.classList.remove("show");
  }
}
tabFiltros.addEventListener("click", ()=>setTab("filtros"));
tabColunas.addEventListener("click", ()=>setTab("colunas"));

/** Colunas configur√°veis (lista + export) */
const COLUMN_OPTIONS = [
  { key:"projeto", label:"Projeto", col:COLS.projeto, default:true },
  { key:"agente", label:"Agente respons√°vel", col:COLS.agente, default:true },
  { key:"avnp", label:"AVNP (%)", col:COLS.avnp, default:true },
  { key:"municipio", label:"Munic√≠pio", col:COLS.municipio, default:true },
  { key:"criterio", label:"Crit√©rio", col:COLS.criterio, default:true },
  { key:"titulo", label:"T√≠tulo", col:COLS.titulo, default:true },
  { key:"nota", label:"Nota", col:COLS.nota, default:true },
  { key:"prazo", label:"Prazo final", col:COLS.prazo, default:true },
];

function getSelectedCols(){
  const map = {};
  colsChecks.querySelectorAll("input[type=checkbox]").forEach(ch=>{
    map[ch.value] = ch.checked;
  });
  return map;
}

function renderColsChecks(){
  colsChecks.innerHTML = "";
  for(const opt of COLUMN_OPTIONS){
    const id = "col_" + opt.key;
    const wrap = document.createElement("label");
    wrap.className = "chk";
    wrap.innerHTML = `<input type="checkbox" id="${id}" value="${opt.key}" ${opt.default ? "checked":""}> ${escapeHtml(opt.label)}`;
    colsChecks.appendChild(wrap);
  }

  colsChecks.querySelectorAll("input[type=checkbox]").forEach(ch=>{
    ch.addEventListener("change", ()=>applyFilters());
  });
}

/** Load filtros */
async function loadFiltersData(){
  // pega tudo que pode existir (safeSelect vai remover se faltar)
  const wantedCols = [
    COLS.nota, COLS.base, COLS.municipio, COLS.criterio, COLS.prazo,
    COLS.titulo, COLS.projeto, COLS.agente, COLS.avnp
  ];

  const { data, error } = await safeSelect(TBL_OBRAS, wantedCols);
  if(error) throw error;

  ALL_OBRAS = (data || []).map(o => ({
    ...o,
    [COLS.nota]: normNota(o[COLS.nota]),
  }));

  BASES = uniq(ALL_OBRAS.map(o => o[COLS.base] ?? ""));

  selBase.innerHTML = `<option value="">Todas</option>` + BASES.map(b => `<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join("");

  const municipios = uniq(ALL_OBRAS.map(o => o[COLS.municipio] ?? ""));
  selMunicipio.innerHTML = `<option value="">Todos</option>` + municipios.map(m => `<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("");

  const criterios = uniq(ALL_OBRAS.map(o => o[COLS.criterio] ?? ""));
  selCriterio.innerHTML = `<option value="">Todos</option>` + criterios.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

  renderExportBases();
}

/** Regras do dia / pr√≥ximos 5 por base */
function applyFilters(){
  const dateISO = inpDate.value;
  const base = selBase.value;
  const mun = selMunicipio.value;
  const crit = selCriterio.value;

  let arr = ALL_OBRAS.slice();
  if(base) arr = arr.filter(o => String(o[COLS.base]||"") === base);
  if(mun) arr = arr.filter(o => String(o[COLS.municipio]||"") === mun);
  if(crit) arr = arr.filter(o => String(o[COLS.criterio]||"") === crit);

  const basesToShow = base ? [base] : (BASES.length ? BASES : ["(Sem base)"]);

  const byBase = {};
  for(const b of basesToShow){
    const subset = base ? arr : arr.filter(o => String(o[COLS.base]||"") === b);

    const sameDay = subset.filter(o => {
      const v = o[COLS.prazo];
      if(!v) return false;
      const iso = String(v).slice(0,10);
      return iso === dateISO;
    });

    if(sameDay.length){
      byBase[b] = sameDay;
    } else {
      const endISO = addDays(dateISO, 5);
      const upcoming = subset
        .filter(o => {
          const v = o[COLS.prazo];
          if(!v) return false;
          const iso = String(v).slice(0,10);
          return iso >= dateISO && iso <= endISO;
        })
        .sort((a,b)=>{
          const da = String(a[COLS.prazo]||"");
          const db = String(b[COLS.prazo]||"");
          return da.localeCompare(db);
        })
        .slice(0,5);
      byBase[b] = upcoming;
    }
  }

  renderBases(byBase);
}

/** Render din√¢mico conforme colunas selecionadas */
function renderBases(byBase){
  elBases.innerHTML = "";

  const selected = getSelectedCols();
  const bases = Object.keys(byBase);

  let totalShown = 0;
  for(const b of bases) totalShown += (byBase[b]||[]).length;
  elPill.textContent = `Mostrando ${totalShown} obras (por base)`;

  // monta colunas efetivas (ordem)
  const colsToShow = COLUMN_OPTIONS.filter(o => selected[o.key]).map(o=>o.key);

  // garante que pelo menos T√≠tulo apare√ßa (se desmarcar tudo)
  if(colsToShow.length === 0) colsToShow.push("titulo");

  // grid template: (cols) + a√ß√µes
  const gridTemplate = `repeat(${colsToShow.length}, minmax(120px, 1fr)) 130px`;

  for(const baseName of bases){
    const list = byBase[baseName] || [];

    const card = document.createElement("div");
    card.className = "base-card";

    const head = document.createElement("div");
    head.className = "base-head";
    head.innerHTML = `
      <div class="base-title">${escapeHtml(baseName || "SEM BASE")}</div>
      <div class="base-count">${list.length} itens</div>
    `;
    card.appendChild(head);

    const table = document.createElement("div");
    table.className = "table";

    const headRow = document.createElement("div");
    headRow.className = "row head";
    headRow.style.gridTemplateColumns = gridTemplate;

    headRow.innerHTML = colsToShow.map(k=>{
      const opt = COLUMN_OPTIONS.find(o=>o.key===k);
      return `<div class="cell">${escapeHtml(opt ? opt.label : k)}</div>`;
    }).join("") + `<div class="cell" style="text-align:right;">A√ß√µes</div>`;

    table.appendChild(headRow);

    if(!list.length){
      const empty = document.createElement("div");
      empty.className = "row";
      empty.style.gridTemplateColumns = gridTemplate;
      empty.innerHTML = `<div class="cell mono" style="grid-column:1/-1;">Sem obras para este crit√©rio.</div>`;
      table.appendChild(empty);
    } else {
      for(const o of list){
        const row = document.createElement("div");
        row.className = "row";
        row.style.gridTemplateColumns = gridTemplate;

        const cells = [];
        for(const k of colsToShow){
          if(k === "nota"){
            cells.push(`<div class="cell mono">${escapeHtml(safeText(o[COLS.nota]))}</div>`);
          } else if(k === "prazo"){
            cells.push(`<div class="cell"><span class="badge gray">${escapeHtml(fmtDateBR(o[COLS.prazo]))}</span></div>`);
          } else if(k === "avnp"){
            cells.push(`<div class="cell"><span class="badge">${escapeHtml(toPercent(o[COLS.avnp]))}</span></div>`);
          } else if(k === "titulo"){
            cells.push(`<div class="cell"><strong>${escapeHtml(safeText(o[COLS.titulo]))}</strong></div>`);
          } else if(k === "projeto"){
            cells.push(`<div class="cell">${escapeHtml(safeText(o[COLS.projeto]))}</div>`);
          } else if(k === "agente"){
            cells.push(`<div class="cell">${escapeHtml(safeText(o[COLS.agente]))}</div>`);
          } else if(k === "municipio"){
            cells.push(`<div class="cell">${escapeHtml(safeText(o[COLS.municipio]))}</div>`);
          } else if(k === "criterio"){
            cells.push(`<div class="cell">${escapeHtml(safeText(o[COLS.criterio]))}</div>`);
          } else {
            // fallback
            cells.push(`<div class="cell">${escapeHtml(safeText(o[k]))}</div>`);
          }
        }

        const nota = safeText(o[COLS.nota]);
        const titulo = safeText(o[COLS.titulo]);
        const municipio = safeText(o[COLS.municipio]);
        const criterio = safeText(o[COLS.criterio]);
        const projeto = safeText(o[COLS.projeto]);

        row.innerHTML =
          cells.join("") +
          `<div class="cell"><div class="actions">
             <button class="btn small" data-nota="${escapeHtml(nota)}"
               data-titulo="${escapeHtml(titulo)}"
               data-base="${escapeHtml(baseName)}"
               data-mun="${escapeHtml(municipio)}"
               data-crit="${escapeHtml(criterio)}"
               data-proj="${escapeHtml(projeto)}">Notas</button>
           </div></div>`;

        table.appendChild(row);
      }
    }

    card.appendChild(table);
    elBases.appendChild(card);
  }

  elBases.querySelectorAll("button[data-nota]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      openNotes({
        nota: btn.getAttribute("data-nota"),
        titulo: btn.getAttribute("data-titulo"),
        base: btn.getAttribute("data-base"),
        municipio: btn.getAttribute("data-mun"),
        criterio: btn.getAttribute("data-crit"),
        projeto: btn.getAttribute("data-proj"),
      });
    });
  });
}

/** Listeners filtros */
[inpDate, selBase, selMunicipio, selCriterio].forEach(el=>{
  el.addEventListener("change", ()=>applyFilters());
});

/** Top date (SP) */
function setTopDate(){
  const now = new Date();
  const txt = now.toLocaleDateString("pt-BR", { timeZone:"America/Sao_Paulo" });
  document.getElementById("todayTop").textContent = txt;
}

/** Boot */
async function loadAll(){
  clearError();
  elPill.textContent = "Carregando‚Ä¶";
  elBases.innerHTML = "";

  try{
    setTopDate();

    if(!inpDate.value){
      inpDate.value = new Date().toLocaleDateString("en-CA",{ timeZone:"America/Sao_Paulo" });
    }

    renderColsChecks();
    await loadFiltersData();
    setTab("filtros");
    applyFilters();
  } catch(e){
    console.error(e);
    elPill.textContent = "Erro";
    showError(
      `N√£o consegui carregar dados da tabela '${TBL_OBRAS}'.\n\n`+
      `Detalhe: ${e?.message ? e.message : JSON.stringify(e)}\n\n`+
      `Verifique:\n- SUPABASE_URL e ANON_KEY\n- RLS/policies (SELECT para anon)\n- nomes das colunas (min√∫sculo)`
    );
  }
}

/** ============================
 *  Export WhatsApp (usa colunas selecionadas)
 *  ============================ */
const modalExport = document.getElementById("modalExport");
const expStart = document.getElementById("expStart");
const expEnd = document.getElementById("expEnd");
const expBases = document.getElementById("expBases");
const expPreview = document.getElementById("expPreview");

document.getElementById("btnExport").addEventListener("click", openExport);
document.getElementById("btnCloseExport").addEventListener("click", closeExport);
document.getElementById("btnBuildPreview").addEventListener("click", buildExportPreview);
document.getElementById("btnSendWA").addEventListener("click", openWhatsApp);

function openExport(){
  expStart.value = inpDate.value;
  expEnd.value = inpDate.value;
  renderExportBases();
  expPreview.value = "";
  modalExport.classList.add("show");
}
function closeExport(){ modalExport.classList.remove("show"); }

function renderExportBases(){
  expBases.innerHTML = "";
  for(const b of BASES){
    const id = "exp_" + b.replaceAll(" ","_").replaceAll("/","_");
    const wrap = document.createElement("label");
    wrap.className = "chk";
    wrap.innerHTML = `<input type="checkbox" id="${escapeHtml(id)}" value="${escapeHtml(b)}" checked> ${escapeHtml(b)}`;
    expBases.appendChild(wrap);
  }
}
function getSelectedExportBases(){
  const vals = [];
  expBases.querySelectorAll("input[type=checkbox]").forEach(ch=>{ if(ch.checked) vals.push(ch.value); });
  return vals;
}

function buildExportPreview(){
  const start = expStart.value;
  const end = expEnd.value;
  const bases = getSelectedExportBases();
  if(!start || !end) { expPreview.value="Selecione data inicial e final."; return; }
  if(start > end) { expPreview.value="A data inicial n√£o pode ser maior que a final."; return; }
  if(!bases.length) { expPreview.value="Selecione ao menos 1 base."; return; }

  const selected = getSelectedCols();
  const colsToShow = COLUMN_OPTIONS.filter(o => selected[o.key]).map(o=>o.key);
  if(colsToShow.length === 0) colsToShow.push("titulo");

  const items = ALL_OBRAS.filter(o=>{
    const iso = String(o[COLS.prazo]||"").slice(0,10);
    if(!iso) return false;
    if(iso < start || iso > end) return false;
    const b = String(o[COLS.base]||"");
    if(!bases.includes(b)) return false;

    const mun = selMunicipio.value;
    const crit = selCriterio.value;
    if(mun && String(o[COLS.municipio]||"") !== mun) return false;
    if(crit && String(o[COLS.criterio]||"") !== crit) return false;

    return true;
  }).sort((a,b)=>{
    const da = String(a[COLS.prazo]||"");
    const db = String(b[COLS.prazo]||"");
    const ba = String(a[COLS.base]||"");
    const bb = String(b[COLS.base]||"");
    if(da !== db) return da.localeCompare(db);
    if(ba !== bb) return ba.localeCompare(bb);
    return String(a[COLS.titulo]||"").localeCompare(String(b[COLS.titulo]||""));
  });

  if(!items.length){
    expPreview.value = "Nenhuma obra encontrada nesse per√≠odo (com os filtros atuais).";
    return;
  }

  const group = {};
  for(const o of items){
    const d = String(o[COLS.prazo]||"").slice(0,10);
    const b = String(o[COLS.base]||"");
    if(!group[d]) group[d] = {};
    if(!group[d][b]) group[d][b] = [];
    group[d][b].push(o);
  }

  let msg = `üìå *Obras planejadas (${fmtDateBR(start)} ‚Üí ${fmtDateBR(end)})*\n`;
  msg += `Filtros: Munic√≠pio=${selMunicipio.value || "Todos"} | Crit√©rio=${selCriterio.value || "Todos"}\n\n`;

  const dates = Object.keys(group).sort();
  for(const d of dates){
    msg += `üóìÔ∏è *${fmtDateBR(d)}*\n`;
    for(const b of Object.keys(group[d]).sort()){
      msg += `\nüè¢ *${b}*\n`;
      for(const o of group[d][b]){
        // linha principal: t√≠tulo sempre no topo
        const titulo = safeText(o[COLS.titulo]);
        msg += `‚Ä¢ ${titulo}\n`;

        // imprime campos selecionados (exceto t√≠tulo, que j√° foi)
        for(const k of colsToShow){
          if(k === "titulo") continue;

          if(k === "nota") msg += `  Nota: ${safeText(o[COLS.nota])}\n`;
          else if(k === "projeto") msg += `  Projeto: ${safeText(o[COLS.projeto])}\n`;
          else if(k === "agente") msg += `  Agente: ${safeText(o[COLS.agente])}\n`;
          else if(k === "municipio") msg += `  Munic√≠pio: ${safeText(o[COLS.municipio])}\n`;
          else if(k === "criterio") msg += `  Crit√©rio: ${safeText(o[COLS.criterio])}\n`;
          else if(k === "prazo") msg += `  Prazo final: ${fmtDateBR(o[COLS.prazo])}\n`;
          else if(k === "avnp") msg += `  AVNP: ${toPercent(o[COLS.avnp])}\n`;
        }
        msg += "\n";
      }
    }
    msg += "\n";
  }

  expPreview.value = msg.trim();
}

function openWhatsApp(){
  if(!expPreview.value.trim()) buildExportPreview();
  const text = expPreview.value.trim();
  if(!text) return;
  window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
}

/** ============================
 *  Notes (fallback se status_execucao n√£o existir)
 *  ============================ */
const modalNotes = document.getElementById("modalNotes");
const notesTitle = document.getElementById("notesTitle");
const noteAuthor = document.getElementById("noteAuthor");
const noteText = document.getElementById("noteText");
const noteStatus = document.getElementById("noteStatus");
const notesErr = document.getElementById("notesErr");
const notesList = document.getElementById("notesList");

document.getElementById("btnCloseNotes").addEventListener("click", closeNotes);
document.getElementById("btnSaveNote").addEventListener("click", saveNote);
document.getElementById("btnReloadNotes").addEventListener("click", ()=>loadNotes(true));

let CURRENT_NOTA = null;

function openNotes(meta){
  CURRENT_NOTA = normNota(meta.nota);
  notesTitle.textContent = `Notas ‚Ä¢ Nota ${CURRENT_NOTA}`;
  notesErr.style.display = "none";
  notesErr.textContent = "";
  noteText.value = "";
  modalNotes.classList.add("show");
  loadNotes(false);
}
function closeNotes(){ modalNotes.classList.remove("show"); }

async function loadNotes(){
  if(!CURRENT_NOTA) return;
  notesErr.style.display="none"; notesErr.textContent="";
  notesList.innerHTML = "Carregando‚Ä¶";

  const tryCols1 = ["id","nota","author","note","created_at","status_execucao"];
  const tryCols2 = ["id","nota","author","note","created_at"];

  let r1 = await supabase.from(TBL_NOTES)
    .select(tryCols1.join(","))
    .eq("nota", CURRENT_NOTA)
    .order("created_at",{ ascending:false });

  let data = null;
  if(r1.error){
    if(String(r1.error.code)==="42703" || String(r1.error.message||"").includes("does not exist")){
      const r2 = await supabase.from(TBL_NOTES)
        .select(tryCols2.join(","))
        .eq("nota", CURRENT_NOTA)
        .order("created_at",{ ascending:false });

      if(r2.error){
        notesList.innerHTML = "";
        notesErr.style.display="block";
        notesErr.textContent = "Erro ao carregar notas: " + (r2.error.message || JSON.stringify(r2.error));
        return;
      }
      data = r2.data || [];
    } else {
      notesList.innerHTML = "";
      notesErr.style.display="block";
      notesErr.textContent = "Erro ao carregar notas: " + (r1.error.message || JSON.stringify(r1.error));
      return;
    }
  } else {
    data = r1.data || [];
  }

  if(!data.length){
    notesList.innerHTML = `<div style="color:var(--muted);">Nenhuma nota ainda.</div>`;
    return;
  }

  notesList.innerHTML = "";
  for(const n of data){
    const card = document.createElement("div");
    card.style.border = "1px solid var(--line)";
    card.style.borderRadius = "14px";
    card.style.padding = "10px 12px";
    card.style.background = "rgba(255,255,255,.04)";

    const dt = n.created_at ? new Date(n.created_at).toLocaleString("pt-BR",{ timeZone:"America/Sao_Paulo" }) : "‚Äî";
    const status = n.status_execucao ? ` ‚Ä¢ <span class="badge">${escapeHtml(n.status_execucao)}</span>` : "";

    card.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
        <div style="font-weight:900;">${escapeHtml(n.author || "‚Äî")}${status}</div>
        <div style="color:var(--muted); font-family:var(--mono); font-size:12px;">${escapeHtml(dt)}</div>
      </div>
      <div style="margin-top:8px; white-space:pre-wrap; line-height:1.35;">${escapeHtml(n.note || "")}</div>
    `;
    notesList.appendChild(card);
  }
}

async function saveNote(){
  if(!CURRENT_NOTA) return;

  const author = (noteAuthor.value || "").trim();
  const text = (noteText.value || "").trim();
  const status = (noteStatus.value || "").trim();

  if(!author){ notesErr.style.display="block"; notesErr.textContent="Informe seu nome."; return; }
  if(!text){ notesErr.style.display="block"; notesErr.textContent="Escreva a nota."; return; }

  notesErr.style.display="none"; notesErr.textContent="";

  // tenta com status_execucao; se n√£o existir, cai no fallback sem coluna
  const res = await supabase.from(TBL_NOTES).insert({
    nota: CURRENT_NOTA,
    author,
    note: text,
    status_execucao: status
  });

  if(res.error){
    if(String(res.error.code)==="42703" || String(res.error.message||"").includes("does not exist")){
      const res2 = await supabase.from(TBL_NOTES).insert({
        nota: CURRENT_NOTA,
        author,
        note: `(${status}) ${text}`
      });
      if(res2.error){
        notesErr.style.display="block";
        notesErr.textContent="Erro ao salvar nota: " + (res2.error.message || JSON.stringify(res2.error));
        return;
      }
    } else {
      notesErr.style.display="block";
      notesErr.textContent="Erro ao salvar nota: " + (res.error.message || JSON.stringify(res.error));
      return;
    }
  }

  noteText.value="";
  await loadNotes(true);
}

/** Start */
loadAll();
</script>
</body>
</html>